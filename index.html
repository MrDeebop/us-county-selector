<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>U.S. County Selection Tool</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .upload-section {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .map-container {
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-top: 20px;
        }
        .instructions {
            background: #e7f4ff;
            padding: 15px;
            border-left: 4px solid #3498db;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #2980b9;
        }
        .error {
            color: #e74c3c;
            margin-top: 10px;
        }
        .success {
            color: #27ae60;
            margin-top: 10px;
        }
        .file-input-wrapper {
            margin: 15px 0;
        }
        .loading {
            display: none;
            margin: 10px 0;
        }
        .loading.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>U.S. County Selection Tool</h1>
        
        <div class="instructions">
            <h3>Instructions:</h3>
            <ol>
                <li>Obtain a U.S. county shapefile from the <a href="https://www.census.gov/geographies/mapping-files/time-series/geo/carto-boundary-file.html" target="_blank">U.S. Census Bureau</a></li>
                <li>Convert it to GeoJSON using <a href="https://mapshaper.org/" target="_blank">mapshaper.org</a></li>
                <li>Upload the GeoJSON file below</li>
                <li>Interact with the map to select counties</li>
            </ol>
            <p><strong>Note:</strong> Large files may take a moment to process.</p>
        </div>
        
        <div class="upload-section">
            <h2>Upload Your County GeoJSON File</h2>
            <div class="file-input-wrapper">
                <input type="file" id="geojson-file" accept=".geojson,.json">
            </div>
            <button id="upload-btn">Upload and Display</button>
            <div id="loading" class="loading">
                <p>Processing file... This may take a moment for large files.</p>
            </div>
            <div id="message"></div>
        </div>
        
        <div class="map-container" id="map"></div>
        
        <div id="selection-info" style="margin-top: 20px;"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Initialize map
        const map = L.map('map').setView([39.8283, -98.5795], 4);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // UI elements
        const fileInput = document.getElementById('geojson-file');
        const uploadBtn = document.getElementById('upload-btn');
        const messageDiv = document.getElementById('message');
        const loadingDiv = document.getElementById('loading');
        const selectionInfo = document.getElementById('selection-info');
        
        let geoJsonLayer = null;
        let selectedCounties = [];

        uploadBtn.addEventListener('click', handleFileUpload);

        function handleFileUpload() {
            const file = fileInput.files[0];
            
            if (!file) {
                showMessage('Please select a GeoJSON file first.', 'error');
                return;
            }
            
            if (!file.name.endsWith('.geojson') && !file.name.endsWith('.json')) {
                showMessage('Please upload a valid GeoJSON file (.geojson or .json extension).', 'error');
                return;
            }
            
            loadingDiv.classList.add('active');
            messageDiv.textContent = '';
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const geojsonData = JSON.parse(e.target.result);
                    
                    // Validate GeoJSON structure
                    if (!geojsonData.type || !geojsonData.features) {
                        throw new Error('Invalid GeoJSON structure. The file should contain FeatureCollection.');
                    }
                    
                    // Clear previous layer if exists
                    if (geoJsonLayer) {
                        map.removeLayer(geoJsonLayer);
                        selectedCounties = [];
                        updateSelectionInfo();
                    }
                    
                    // Process and display the GeoJSON
                    processGeoJSON(geojsonData);
                    
                    showMessage('File successfully loaded and displayed.', 'success');
                } catch (error) {
                    showMessage(`Error processing file: ${error.message}`, 'error');
                    console.error(error);
                } finally {
                    loadingDiv.classList.remove('active');
                }
            };
            
            reader.onerror = function() {
                showMessage('Error reading file. Please try again.', 'error');
                loadingDiv.classList.remove('active');
            };
            
            reader.readAsText(file);
        }
        
        function processGeoJSON(geojsonData) {
            // First log the properties to see what's available
            console.log("Sample feature properties:", geojsonData.features[0].properties);
            
            // Style function for the GeoJSON
            function style(feature) {
                return {
                    fillColor: '#3388ff',
                    weight: 1,
                    opacity: 1,
                    color: 'white',
                    dashArray: '3',
                    fillOpacity: 0.7
                };
            }
            
            // Highlight feature on hover
            function highlightFeature(e) {
                const layer = e.target;
                
                layer.setStyle({
                    weight: 3,
                    color: '#666',
                    dashArray: '',
                    fillOpacity: 0.7
                });
                
                layer.bringToFront();
                
                // Show county and state name in info panel
                const properties = layer.feature.properties;
                const countyName = properties.NAME || properties.name || 'Unnamed County';
                const stateName = getStateName(properties);
                selectionInfo.innerHTML = `<strong>Hovering:</strong> ${countyName}, ${stateName}`;
            }
            
            function resetHighlight(e) {
                geoJsonLayer.resetStyle(e.target);
                selectionInfo.textContent = '';
            }
            
            function onEachFeature(feature, layer) {
                // Get county and state names from properties
                const properties = feature.properties;
                const countyName = properties.NAME || properties.name || 'Unnamed County';
                const stateName = getStateName(properties);
                const fullName = `${countyName}, ${stateName}`;
                
                // Store the full name in the feature for later use
                feature.properties._fullName = fullName;
                
                // Bind tooltip with county and state
                layer.bindTooltip(fullName);
                
                // Add click event
                layer.on({
                    click: function(e) {
                        const layer = e.target;
                        
                        // Toggle selection
                        if (selectedCounties.includes(layer.feature)) {
                            // Deselect
                            selectedCounties = selectedCounties.filter(f => f !== layer.feature);
                            layer.setStyle({
                                fillColor: '#3388ff',
                                weight: 1
                            });
                        } else {
                            // Select
                            selectedCounties.push(layer.feature);
                            layer.setStyle({
                                fillColor: '#e74c3c',
                                weight: 2
                            });
                        }
                        
                        updateSelectionInfo();
                    },
                    mouseover: highlightFeature,
                    mouseout: resetHighlight
                });
            }
            
            // Create GeoJSON layer
            geoJsonLayer = L.geoJSON(geojsonData, {
                style: style,
                onEachFeature: onEachFeature
            }).addTo(map);
            
            // Fit map to the GeoJSON bounds
            map.fitBounds(geoJsonLayer.getBounds());
        }
        
        // Helper function to get state name from properties
        function getStateName(properties) {
            // Try different possible property names for state
            if (properties.STATE_NAME) return properties.STATE_NAME;
            if (properties.state_name) return properties.state_name;
            if (properties.STUSPS) return getStateNameFromAbbr(properties.STUSPS);
            if (properties.STATEFP) return getStateNameFromFips(properties.STATEFP);
            
            return 'Unknown State';
        }
        
        // Helper function to get state name from FIPS code
        function getStateNameFromFips(fipsCode) {
            const fipsToState = {
                '01': 'Alabama', '02': 'Alaska', '04': 'Arizona', '05': 'Arkansas',
                '06': 'California', '08': 'Colorado', '09': 'Connecticut', '10': 'Delaware',
                '11': 'District of Columbia', '12': 'Florida', '13': 'Georgia', '15': 'Hawaii',
                '16': 'Idaho', '17': 'Illinois', '18': 'Indiana', '19': 'Iowa',
                '20': 'Kansas', '21': 'Kentucky', '22': 'Louisiana', '23': 'Maine',
                '24': 'Maryland', '25': 'Massachusetts', '26': 'Michigan', '27': 'Minnesota',
                '28': 'Mississippi', '29': 'Missouri', '30': 'Montana', '31': 'Nebraska',
                '32': 'Nevada', '33': 'New Hampshire', '34': 'New Jersey', '35': 'New Mexico',
                '36': 'New York', '37': 'North Carolina', '38': 'North Dakota', '39': 'Ohio',
                '40': 'Oklahoma', '41': 'Oregon', '42': 'Pennsylvania', '44': 'Rhode Island',
                '45': 'South Carolina', '46': 'South Dakota', '47': 'Tennessee', '48': 'Texas',
                '49': 'Utah', '50': 'Vermont', '51': 'Virginia', '53': 'Washington',
                '54': 'West Virginia', '55': 'Wisconsin', '56': 'Wyoming',
                '60': 'American Samoa', '66': 'Guam', '69': 'Northern Mariana Islands',
                '72': 'Puerto Rico', '78': 'Virgin Islands'
            };
            
            return fipsToState[fipsCode] || 'Unknown State';
        }
        
        // Helper function to get state name from abbreviation
        function getStateNameFromAbbr(abbr) {
            const abbrToState = {
                'AL': 'Alabama', 'AK': 'Alaska', 'AZ': 'Arizona', 'AR': 'Arkansas',
                'CA': 'California', 'CO': 'Colorado', 'CT': 'Connecticut', 'DE': 'Delaware',
                'DC': 'District of Columbia', 'FL': 'Florida', 'GA': 'Georgia', 'HI': 'Hawaii',
                'ID': 'Idaho', 'IL': 'Illinois', 'IN': 'Indiana', 'IA': 'Iowa',
                'KS': 'Kansas', 'KY': 'Kentucky', 'LA': 'Louisiana', 'ME': 'Maine',
                'MD': 'Maryland', 'MA': 'Massachusetts', 'MI': 'Michigan', 'MN': 'Minnesota',
                'MS': 'Mississippi', 'MO': 'Missouri', 'MT': 'Montana', 'NE': 'Nebraska',
                'NV': 'Nevada', 'NH': 'New Hampshire', 'NJ': 'New Jersey', 'NM': 'New Mexico',
                'NY': 'New York', 'NC': 'North Carolina', 'ND': 'North Dakota', 'OH': 'Ohio',
                'OK': 'Oklahoma', 'OR': 'Oregon', 'PA': 'Pennsylvania', 'RI': 'Rhode Island',
                'SC': 'South Carolina', 'SD': 'South Dakota', 'TN': 'Tennessee', 'TX': 'Texas',
                'UT': 'Utah', 'VT': 'Vermont', 'VA': 'Virginia', 'WA': 'Washington',
                'WV': 'West Virginia', 'WI': 'Wisconsin', 'WY': 'Wyoming',
                'AS': 'American Samoa', 'GU': 'Guam', 'MP': 'Northern Mariana Islands',
                'PR': 'Puerto Rico', 'VI': 'Virgin Islands'
            };
            
            return abbrToState[abbr] || 'Unknown State';
        }
        
        function updateSelectionInfo() {
            if (selectedCounties.length === 0) {
                selectionInfo.innerHTML = '<strong>No counties selected</strong>';
                return;
            }
            
            let html = `<strong>Selected Counties (${selectedCounties.length}):</strong><ul>`;
            
            selectedCounties.forEach(feature => {
                html += `<li>${feature.properties._fullName || 'Unknown County'}</li>`;
            });
            
            html += '</ul>';
            selectionInfo.innerHTML = html;
        }
        
        function showMessage(text, type) {
            messageDiv.textContent = text;
            messageDiv.className = type;
        }
    </script>
</body>
</html>
