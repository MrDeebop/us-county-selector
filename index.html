<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>County Grouping Tool</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .upload-section, .group-section {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
        }
        .map-container {
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 8px;
            grid-column: 1 / -1;
        }
        .instructions {
            background: #e7f4ff;
            padding: 15px;
            border-left: 4px solid #3498db;
            margin-bottom: 20px;
            border-radius: 4px;
            grid-column: 1 / -1;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px 0;
        }
        button:hover {
            background: #2980b9;
        }
        .error {
            color: #e74c3c;
            margin-top: 10px;
        }
        .success {
            color: #27ae60;
            margin-top: 10px;
        }
        .loading {
            display: none;
            margin: 10px 0;
        }
        .group-list, .county-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            background: white;
            margin-top: 10px;
        }
        .group-item {
            padding: 8px;
            margin: 5px 0;
            background: #e8f4fc;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
        }
        .county-item {
            padding: 5px;
            margin: 3px 0;
            background: #f9f9f9;
            border-radius: 3px;
            font-size: 14px;
        }
        .group-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        input[type="text"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }
        .export-section {
            margin-top: 20px;
            padding: 15px;
            background: #e8f8f0;
            border-radius: 8px;
        }
        #drop-zone {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            margin: 10px 0;
            border-radius: 8px;
        }
        #drop-zone.active {
            border-color: #3498db;
            background-color: #f0f8ff;
        }
        .progress-bar {
            width: 100%;
            background: #ddd;
            height: 20px;
            margin-top: 10px;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress {
            height: 100%;
            background: #3498db;
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="grid-column: 1 / -1;">County Grouping Tool</h1>
        
        <div class="instructions">
            <h3>Instructions:</h3>
            <ol>
                <li>Upload your shapefile (drag & drop or select files)</li>
                <li>Click counties on the map to select them</li>
                <li>Create groups and add selected counties to them</li>
                <li>Export your groups to Excel when finished</li>
            </ol>
        </div>
        
        <div class="upload-section">
            <h2>Shapefile Upload</h2>
            <div id="drop-zone">
                <p>Drag and drop your shapefile folder here</p>
                <p>or</p>
                <input type="file" id="shapefile-upload" multiple webkitdirectory directory>
            </div>
            <button id="upload-btn">Process Shapefile</button>
            <div id="loading" class="loading">
                <p id="loading-text">Processing files...</p>
                <div class="progress-bar">
                    <div id="progress" class="progress"></div>
                </div>
            </div>
            <div id="message"></div>
        </div>
        
        <div class="group-section">
            <h2>County Groups</h2>
            <div class="group-controls">
                <input type="text" id="group-name" placeholder="Enter group name">
                <button id="create-group">Create Group</button>
            </div>
            <div id="groups" class="group-list"></div>
            
            <h3>Selected Counties</h3>
            <div id="selected-counties" class="county-list"></div>
            <button id="clear-selection" style="margin-top: 10px;">Clear Selection</button>
        </div>
        
        <div class="map-container" id="map"></div>
        
        <div class="export-section">
            <h2>Export Groups</h2>
            <button id="export-excel">Export to Excel</button>
            <div id="export-message"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/shpjs@4.0.2/dist/shp.js"></script>
    <script>
        // Initialize map
        const map = L.map('map').setView([39.8283, -98.5795], 4);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // State management
        const state = {
            selectedCounties: [],
            groups: {},
            currentGroupId: null
        };

        // DOM elements
        const elements = {
            map,
            fileInput: document.getElementById('shapefile-upload'),
            uploadBtn: document.getElementById('upload-btn'),
            messageDiv: document.getElementById('message'),
            loadingDiv: document.getElementById('loading'),
            loadingText: document.getElementById('loading-text'),
            progressBar: document.getElementById('progress'),
            dropZone: document.getElementById('drop-zone'),
            groupNameInput: document.getElementById('group-name'),
            createGroupBtn: document.getElementById('create-group'),
            groupsContainer: document.getElementById('groups'),
            selectedCountiesContainer: document.getElementById('selected-counties'),
            clearSelectionBtn: document.getElementById('clear-selection'),
            exportExcelBtn: document.getElementById('export-excel'),
            exportMessage: document.getElementById('export-message')
        };

        let geoJsonLayer = null;

        // Event listeners
        function setupEventListeners() {
            // File upload
            elements.uploadBtn.addEventListener('click', handleFileUpload);
            
            // Drag and drop
            elements.dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                elements.dropZone.classList.add('active');
            });
            
            elements.dropZone.addEventListener('dragleave', () => {
                elements.dropZone.classList.remove('active');
            });
            
            elements.dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                elements.dropZone.classList.remove('active');
                handleDroppedFiles(e.dataTransfer.items || e.dataTransfer.files);
            });
            
            // Group management
            elements.createGroupBtn.addEventListener('click', createGroup);
            elements.clearSelectionBtn.addEventListener('click', clearSelection);
            elements.exportExcelBtn.addEventListener('click', exportToExcel);
        }

        // File handling
        async function handleFileUpload() {
            const files = Array.from(elements.fileInput.files);
            if (files.length === 0) {
                showMessage('Please select shapefile files first.', 'error');
                return;
            }
            await processShapefile(files);
        }

        async function handleDroppedFiles(items) {
            const files = [];
            
            // Handle directory drop
            if (items[0]?.webkitGetAsEntry) {
                for (let i = 0; i < items.length; i++) {
                    const item = items[i].webkitGetAsEntry();
                    if (item) await traverseFileTree(item, files);
                }
            } 
            // Handle direct file drop
            else {
                for (let i = 0; i < items.length; i++) {
                    files.push(items[i]);
                }
            }
            
            await processShapefile(files);
        }

        async function traverseFileTree(item, files, path = '') {
            return new Promise((resolve) => {
                if (item.isFile) {
                    item.file((file) => {
                        file.filepath = path + file.name;
                        files.push(file);
                        resolve();
                    });
                } else if (item.isDirectory) {
                    const dirReader = item.createReader();
                    dirReader.readEntries(async (entries) => {
                        for (let i = 0; i < entries.length; i++) {
                            await traverseFileTree(entries[i], files, path + item.name + '/');
                        }
                        resolve();
                    });
                }
            });
        }

        async function processShapefile(files) {
            try {
                showLoading('Processing shapefile...');
                
                // Filter to shapefile components
                const shapefileFiles = files.filter(file => {
                    const ext = file.name.split('.').pop().toLowerCase();
                    return ['shp', 'shx', 'dbf', 'prj', 'cpg', 'xml'].includes(ext);
                });
                
                if (shapefileFiles.length === 0) {
                    throw new Error('No valid shapefile components found');
                }
                
                // Find required files
                const shpFile = shapefileFiles.find(f => f.name.toLowerCase().endsWith('.shp'));
                const dbfFile = shapefileFiles.find(f => f.name.toLowerCase().endsWith('.dbf'));
                
                if (!shpFile || !dbfFile) {
                    throw new Error('Missing required .shp or .dbf files');
                }
                
                // Read files
                const [shpBuffer, dbfBuffer] = await Promise.all([
                    readFileAsArrayBuffer(shpFile),
                    readFileAsArrayBuffer(dbfFile)
                ]);
                
                // Process with shapefile.js
                const geojson = shp.combine([
                    shp.parseShp(shpBuffer),
                    shp.parseDbf(dbfBuffer)
                ]);
                
                // Display on map
                displayGeoJSON(geojson);
                showMessage('Shapefile loaded successfully', 'success');
            } catch (error) {
                showMessage(`Error: ${error.message}`, 'error');
                console.error(error);
            } finally {
                hideLoading();
            }
        }

        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsArrayBuffer(file);
            });
        }

        // Map display functions
        function displayGeoJSON(geojson) {
            // Clear previous layer if exists
            if (geoJsonLayer) {
                map.removeLayer(geoJsonLayer);
                clearSelection();
            }
            
            // Style function
            function style(feature) {
                return {
                    fillColor: '#3388ff',
                    weight: 1,
                    opacity: 1,
                    color: 'white',
                    dashArray: '3',
                    fillOpacity: 0.7
                };
            }
            
            // Highlight on hover
            function highlightFeature(e) {
                const layer = e.target;
                layer.setStyle({
                    weight: 3,
                    color: '#666',
                    dashArray: '',
                    fillOpacity: 0.7
                });
                layer.bringToFront();
            }
            
            function resetHighlight(e) {
                geoJsonLayer.resetStyle(e.target);
            }
            
            // Handle feature clicks
            function onEachFeature(feature, layer) {
                layer.on({
                    click: (e) => toggleCountySelection(feature, layer),
                    mouseover: highlightFeature,
                    mouseout: resetHighlight
                });
            }
            
            // Create GeoJSON layer
            geoJsonLayer = L.geoJSON(geojson, {
                style: style,
                onEachFeature: onEachFeature
            }).addTo(map);
            
            // Fit map to bounds
            map.fitBounds(geoJsonLayer.getBounds());
        }

        // County selection functions
        function toggleCountySelection(feature, layer) {
            const countyId = getCountyId(feature);
            const index = state.selectedCounties.findIndex(c => getCountyId(c) === countyId);
            
            if (index === -1) {
                // Add to selection
                state.selectedCounties.push(feature);
                layer.setStyle({ fillColor: '#e74c3c', weight: 2 });
            } else {
                // Remove from selection
                state.selectedCounties.splice(index, 1);
                layer.setStyle({ fillColor: '#3388ff', weight: 1 });
            }
            
            updateSelectedCountiesDisplay();
        }

        function getCountyId(feature) {
            // Create unique ID from county and state names
            const name = feature.properties.NAME || feature.properties.name || 'unknown';
            const state = feature.properties.STATE_NAME || feature.properties.state_name || 'unknown';
            return `${name}-${state}`.toLowerCase();
        }

        function clearSelection() {
            // Reset styles
            if (geoJsonLayer) {
                state.selectedCounties.forEach(feature => {
                    geoJsonLayer.eachLayer(layer => {
                        if (getCountyId(layer.feature) === getCountyId(feature)) {
                            layer.setStyle({ fillColor: '#3388ff', weight: 1 });
                        }
                    });
                });
            }
            
            state.selectedCounties = [];
            updateSelectedCountiesDisplay();
        }

        // Group management functions
        function createGroup() {
            const groupName = elements.groupNameInput.value.trim();
            if (!groupName) {
                showMessage('Please enter a group name', 'error', elements.exportMessage);
                return;
            }
            
            if (state.selectedCounties.length === 0) {
                showMessage('No counties selected to add to group', 'error', elements.exportMessage);
                return;
            }
            
            const groupId = Date.now().toString();
            state.groups[groupId] = {
                name: groupName,
                counties: [...state.selectedCounties]
            };
            
            renderGroups();
            clearSelection();
            elements.groupNameInput.value = '';
            showMessage(`Group "${groupName}" created with ${state.selectedCounties.length} counties`, 'success', elements.exportMessage);
        }

        function renderGroups() {
            elements.groupsContainer.innerHTML = '';
            
            Object.entries(state.groups).forEach(([groupId, group]) => {
                const groupEl = document.createElement('div');
                groupEl.className = 'group-item';
                
                groupEl.innerHTML = `
                    <div>
                        <strong>${group.name}</strong>
                        <div>${group.counties.length} counties</div>
                    </div>
                    <button data-group-id="${groupId}" class="delete-group">Delete</button>
                `;
                
                elements.groupsContainer.appendChild(groupEl);
                
                // Add delete button event
                groupEl.querySelector('.delete-group').addEventListener('click', (e) => {
                    delete state.groups[e.target.dataset.groupId];
                    renderGroups();
                });
            });
        }

        // Display functions
        function updateSelectedCountiesDisplay() {
            elements.selectedCountiesContainer.innerHTML = '';
            
            if (state.selectedCounties.length === 0) {
                elements.selectedCountiesContainer.innerHTML = '<p>No counties selected</p>';
                return;
            }
            
            state.selectedCounties.forEach(feature => {
                const countyEl = document.createElement('div');
                countyEl.className = 'county-item';
                
                const name = feature.properties.NAME || feature.properties.name || 'Unknown County';
                const stateName = feature.properties.STATE_NAME || feature.properties.state_name || 'Unknown State';
                
                countyEl.textContent = `${name}, ${stateName}`;
                elements.selectedCountiesContainer.appendChild(countyEl);
            });
        }

        // Export functions
        function exportToExcel() {
            if (Object.keys(state.groups).length === 0) {
                showMessage('No groups to export', 'error', elements.exportMessage);
                return;
            }
            
            try {
                // Prepare data
                const data = [];
                
                // Add headers
                data.push(['Group Name', 'County Name', 'State']);
                
                // Add group data
                Object.values(state.groups).forEach(group => {
                    group.counties.forEach(county => {
                        const name = county.properties.NAME || county.properties.name || 'Unknown County';
                        const stateName = county.properties.STATE_NAME || county.properties.state_name || 'Unknown State';
                        data.push([group.name, name, stateName]);
                    });
                });
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, 'County Groups');
                
                // Export
                XLSX.writeFile(wb, 'county_groups.xlsx');
                showMessage('Excel file exported successfully', 'success', elements.exportMessage);
            } catch (error) {
                showMessage(`Export failed: ${error.message}`, 'error', elements.exportMessage);
                console.error(error);
            }
        }

        // UI helper functions
        function showLoading(message) {
            elements.loadingText.textContent = message;
            elements.loadingDiv.style.display = 'block';
            elements.progressBar.style.width = '0%';
        }

        function hideLoading() {
            elements.loadingDiv.style.display = 'none';
        }

        function showMessage(text, type, element = elements.messageDiv) {
            element.textContent = text;
            element.className = type;
            if (type === 'error') console.error(text);
        }

        // Initialize
        setupEventListeners();
        updateSelectedCountiesDisplay();
    </script>
</body>
</html>
